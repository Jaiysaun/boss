#
# Makefile
#
# system build requirements: >=boost-1.45.0, curl
#
# usage:
#   make [options] [targets]
#
# options:
#   debug                       set to 'y' to enable the debug build.  you
#                                 should run 'make clean' before switching
#                                 between debug and non-debug builds.
#
# examples:
#   make                        builds build/boss
#   make DumpHeaders            builds build/DumpHeaders
#   make Testing                builds all projects under Testing/
#   make debug=y                builds a debug version of build/boss
#   make debug=y Testing        builds debug versions of the test projects
#
# notes:
#   make can be run from any directory in the source tree.  the default target
#   in each directory depends on the contents of that directory.  for example,
#   the default target in Testing/DumpHeaders/ is the DumpHeaders binary,
#   whereas the default target in Support/ is the collection of object files
#   generated by the sources in the Support/ directory.


#
# Variables
#

CXX      := g++
CXXFLAGS := -pipe -Wall -Wno-multichar
ifeq (y,$(strip ${debug}))
  CXXFLAGS := -O0 -ggdb3 $(CXXFLAGS)
else
  CXXFLAGS := -O2 $(CXXFLAGS)
endif
INCLUDES := .

PROG_BOSS   := boss
BUILD_DIR   := build
TARGET_BOSS := $(BUILD_DIR)/$(PROG_BOSS)
BOSS_LIBS   := boost_system boost_regex boost_filesystem boost_program_options curl


#
# Targets
#

.PHONY: $(PROG_BOSS) clean

# set default target before including other makefiles
all: $(PROG_BOSS)

include Support/Makefile.inc Common/Makefile.inc Testing/Makefile.inc

$(PROG_BOSS): $(TARGET_SUPPORT) $(TARGET_COMMON) $(TARGET_BOSS)

$(BUILD_DIR)/%.o: %.cpp
	$(CXX) $(CXXFLAGS) -MMD -MP -MT $@ -MF $(BUILD_DIR)/$(<:.cpp=.d) $(addprefix -I,$(INCLUDES)) -o $@ -c $<

clean:
	$(RM) -r $(BUILD_DIR)

$(TARGET_BOSS): $(SUPPORT_OBJS) $(COMMON_OBJS)
	$(CXX) $(CXXFLAGS) -o $@ $(addprefix -l,$(BOSS_LIBS)) $^
